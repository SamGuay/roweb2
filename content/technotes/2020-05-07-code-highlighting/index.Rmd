---
title: Highlights of Hugo Code Highlighting
author:
  - Ma√´lle Salmon
date: '2020-05-07'
slug: code-highlighting
categories: []
tags:
  - RMarkdown
  - hugo
package_version: 0.1.0
description: Explanations around code highlighting in Hugo websites, based on Markdown or R Markdown.
twitterImg: blog/2019/06/04/post-template/name-of-image.png
output:
  html_document:
    keep_md: yes
---

```{r setup, include=FALSE}
# Options to have images saved in the post folder
# And to disable symbols before output
knitr::opts_chunk$set(fig.path = "", comment = "")

# knitr hook to make images output use Hugo options
knitr::knit_hooks$set(
  plot = function(x, options) {
    hugoopts <- options$hugoopts
    paste0(
      "{{<figure src=",
      '"', x, '" ',
      if (!is.null(hugoopts)) {
        glue::glue_collapse(
          glue::glue('{names(hugoopts)}="{hugoopts}"'),
          sep = " "
        )
      },
      ">}}\n"
    )
  }
)

# knitr hook to use Hugo highlighting options
knitr::knit_hooks$set(
  source = function(x, options) {
  hlopts <- options$hlopts
    paste0(
      "```r ",
      if (!is.null(hlopts)) {
      paste0("{",
        glue::glue_collapse(
          glue::glue('{names(hlopts)}={hlopts}'),
          sep = ","
        ), "}"
        )
      },
      "\n", glue::glue_collapse(x, sep = "\n"), "\n```\n"
    )
  }
)
```

Thanks to a quite overdue update of Hugo on our build system[^netlify], our website can now harness the full power of Hugo code highlighting. 
What's code highlighting apart from the reason behind a tongue-twister in this post title?
In this post we shall explain how Hugo's code highlighter, Chroma, helps you prettify your code (i.e. _syntax highlighting_), and accentuate parts of your code (i.e. _line highlighting_).

### Make your code look pretty

If you notice and appreciate the difference between

```
a <- c(1:7, NA)
mean(a, na.rm = TRUE)
```

and 

```r
a <- c(1:7, NA)
mean(a, na.rm = TRUE)
```

you might agree with [Mara Averick's opinion](https://maraaverick.rbind.io/2017/11/r-blog-tips-from-an-inveterate-tweeter-thereof/),

>  Syntax highlighting! üñçÔ∏è Just do it. Life is better when things are colourful.

Now, how does the colours of the second block appear? 

First of all, it's a code block with language information, 

````
```r
a <- c(1:7, NA)
mean(a, na.rm = TRUE)
```
````

as opposed to

````
```
a <- c(1:7, NA)
mean(a, na.rm = TRUE)
```
````

without language information, that won't get highlighted -- although some syntax highlighting tools, not Hugo Chroma, do some guessing.

There are in general two ways in which colors are added to code blocks, **client-side syntax highlighting** and **server-side syntax highlighting**. 
The latter is what Hugo supports nowadays but let's dive into both for the sake of completeness (~~or because I'm proud I now get it~~[^strike]).

#### Client-side syntax highlighting

In this sub-section I'll mostly refer to [highlight.js](https://highlightjs.org) but principles probably apply to other client-side syntax highlighting tools.
The "client-side" part of this phrase is that the html that is served by your website host does not have styling for the code.
In highlight.js case, styling appears after a JS script is loaded and applied. 

If we look at [a post of Mara Averick's](https://maraaverick.rbind.io/2018/07/palettes-archer-poster-edition/) at the time of writing, the html of a block is just

```html
<pre class="r"><code>pal_a &lt;- extract_colours(&quot;https://i.imgur.com/FyEALqr.jpg&quot;, num_col = 8)
par(mfrow = c(1,2))
pie(rep(1, 8), col = pal_a, main = &quot;Palette based on Archer Poster&quot;)
hist(Nile, breaks = 8, col = pal_a, main = &quot;Palette based on Archer Poster&quot;)</code></pre>
```

Now, using Firefox Developer Console, 

<!--html_preserve-->
{{< figure src="mara-blog.png" width=800 alt="Screenshot of blog post with Firefox Developer Console open">}}
<!--/html_preserve-->

we see colours come from CSS classes starting with "hljs".

And in the head of that page (examined via "View source"), there's

```html
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
```

which is the part loading and applying highlight.js to the page.
Now, how does it know what's an R function for instance?
If we look at [highlight.js highlighter for the R language](https://github.com/highlightjs/highlight.js/blob/master/src/languages/r.js), authored by [Joe Cheng](https://twitter.com/jcheng) in 2012, it's a bunch of regular expressions, see for instance the [definition of a string](https://github.com/highlightjs/highlight.js/blob/512ae5f5dcdc6dd24185e6e08737c3679073a9b6/src/languages/r.js#L69-L74).

```js
        className: 'string',
        contains: [hljs.BACKSLASH_ESCAPE],
        variants: [
          {begin: '"', end: '"'},
          {begin: "'", end: "'"}
        ]
```

When using highlight.js on your website, you might need to specify R as a supplementary language in your config, since some languages are bundled by default whilst others are not.
You could also [whip up some code to conditionally load supplementary highlight.js languages](https://github.com/ropensci/roweb2/pull/637).

A big downside of client-side syntax highlighting is loading time: 
It appears quite fast if your internet connection isn't poor, but you might have noticed code blocks changing aspect when loading a web page (first unstyled, then styled).
Moreover, Hugo now supports, and uses by default, an alternative that we'll describe in the following subsection and take advantage of in this post's second section.

#### Server-side syntax highlighting

In server-side syntax highlighting, your website html as served already has styling information

* hard-coded in html, as is since recently the case of [tidyverse.org](https://www.tidyverse.org/) and [blog.r-hub.io](https://blog.r-hub.io);

<!--html_preserve-->
{{< figure src="tidyverse.png" width=800 alt="Screenshot of blog post with Firefox Developer Console open">}}
<!--/html_preserve-->

The html source for one of the blocks of [the page screenshot above](https://www.tidyverse.org/blog/2020/04/dplyr-1-0-0-colwise/) is

```html
div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">df <span style="color:#666">%&gt;%</span> 
  <span style="color:#00f">group_by</span>(g1, g2) <span style="color:#666">%&gt;%</span> 
  <span style="color:#00f">summarise</span>(a <span style="color:#666">=</span> <span style="color:#00f">mean</span>(a), b <span style="color:#666">=</span> <span style="color:#00f">mean</span>(b), c <span style="color:#666">=</span> <span style="color:#00f">mean</span>(c), d <span style="color:#666">=</span> <span style="color:#00f">mean</span>(c))
</code></pre></div>
```

* via the use of CSS classes, as is the case of this website where we wanted to keep using our own style.

How does the styling of an R code block happen?
As highlight

### Emphasize parts of your code

[^netlify]: Our website is deployed via Netlify.
[^strike]: [Support for striking text, with `~~blablabla~~` is also quite new in Hugo](https://gohugo.io/news/0.60.0-relnotes/), thanks to its new Markdown renderer Goldmark!